<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTC/USD Enhanced Predictor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-4">
  <div class="max-w-xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold text-center text-green-400">BTC/USD Advanced Predictor</h1>

    <div class="text-center mt-2">
      <span>Price: <strong id="price">--</strong></span><br>
      <span>24h Change: <span id="change24h">--</span></span>
    </div>

    <div class="grid grid-cols-2 gap-2 text-sm">
      <div>RSI: <span id="rsi">--</span></div>
      <div>MACD Hist: <span id="macd">--</span></div>
      <div>CCI: <span id="cci">--</span></div>
      <div>Momentum: <span id="momentum">--</span></div>
      <div>Stoch RSI: <span id="stochrsi">--</span></div>
      <div>Candle: <span id="candle">--</span></div>
      <div>Volume: <span id="volume">--</span></div>
      <div>Prev High/Low: <span id="prevHigh">--</span> / <span id="prevLow">--</span></div>
    </div>

    <div class="text-center text-xl mt-4">
      Prediction: <span id="prediction" class="font-bold text-yellow-400">Neutral</span>
      (<span id="probability">--%</span>)
    </div>

    <div class="text-center mt-4">
      <button onclick="refresh()" class="bg-blue-600 px-4 py-2 rounded">Refresh</button>
    </div>
  </div>

  <audio id="bullSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="bearSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const TAAPI = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbHVlIjoiNjg2Y2Y3YWU4MDZmZjE2NTFlMjhkYWJlIiwiaWF0IjoxNzUxOTcxNzU4LCJleHAiOjMzMjU2NDM1NzU4fQ.pMXqyFoJ0yCQuQjmT7i-66VNBFSQuEqvRi_oJNntWis";
    const sym = "BTC/USDT", interval = "1h";
    let lastAlert = 0, prevHigh = null, prevLow = null;

    function speak(t) {
      if (!speechSynthesis) return;
      let u = new SpeechSynthesisUtterance(t);
      u.lang = "en-US"; speechSynthesis.speak(u);
    }

    async function fetchTA(ind) {
      let url = `https://api.taapi.io/${ind}?secret=${TAAPI}&exchange=binance&symbol=${sym}&interval=${interval}`;
      let res = await fetch(url), j = await res.json();
      return j.value ?? j.valueMACDHist ?? j.valueCCI ?? j.valueMomentum ?? j.valueStochRSI ?? j.valueCandle ?? null;
    }

    async function refresh(){
      document.querySelectorAll('#price,#change24h,#rsi,#macd,#cci,#momentum,#stochrsi,#candle,#volume').forEach(el=> el.textContent='â€¦');

      let tk = await fetch("https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT").then(r=>r.json());
      let p = +tk.lastPrice, c = +tk.priceChangePercent;
      document.getElementById('price').textContent = p.toFixed(2);
      let chE = document.getElementById('change24h');
      chE.textContent = c.toFixed(2)+'%';
      chE.className = c>=0?'text-green-400':'text-red-400';

      let [rsi, macd, cci, mom, stoch, candle, vol] = await Promise.all([
        fetchTA("rsi"), fetchTA("macd"), fetchTA("cci"), fetchTA("momentum"),
        fetchTA("stochrsi"), fetchTA("candle"), fetchTA("volume")
      ]);

      [['rsi',rsi],['macd',macd],['cci',cci],['momentum',mom],['stochrsi',stoch],['candle',candle],['volume',vol]]
      .forEach(([id,v])=> document.getElementById(id).textContent = v===null?'--': typeof v==='string'? v : v.toFixed(id==='candle'?0: id==='volume'?0:2));

      let kl = await fetch("https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=2").then(r=>r.json());
      prevHigh = +kl[0][2]; prevLow = +kl[0][3];
      document.getElementById('prevHigh').textContent = prevHigh.toFixed(2);
      document.getElementById('prevLow').textContent  = prevLow.toFixed(2);

      // Scoring
      let bull=0, bear=0;
      if (macd>0) bull+=25; else bear+=25;
      if (rsi>55) bull+=15; else if (rsi<45) bear+=15;
      if (cci>100) bull+=10; else if (cci<-100) bear+=10;
      if (mom>0) bull+=10; else bear+=10;
      if (stoch>0.8) bear+=5; else if(stoch<0.2) bull+=5;
      if (candle==="DOJI") bear+=5; // caution
      if (vol>0) bull+=5;
      if (p>prevHigh) { bull+=20; levelAlert(p,prevHigh,"High","bull"); }
      if (p<prevLow)  { bear+=20; levelAlert(p,prevLow,"Low","bear"); }

      let total = bull + bear, prob = total? Math.abs(bull-bear)/total*100 : 0;
      let pred = 'Neutral', color='text-yellow-400';
      if(bull>bear && bull>=50){ pred='Bullish'; color='text-green-400';}
      if(bear>bull && bear>=50){ pred='Bearish'; color='text-red-400';}

      document.getElementById('prediction').textContent = pred;
      document.getElementById('prediction').className = 'font-bold ' + color;
      document.getElementById('probability').textContent = prob.toFixed(0)+'%';
    }

    function levelAlert(price, lvl, name, type){
      if(Math.abs(price-lvl)/lvl<0.002 && Date.now()-lastAlert>10000){
        document.getElementById(type==="bull"?"bullSound":"bearSound").play();
        speak(`${type==="bull"?"Bullish":"Bearish"} breakout at previous ${name}`);
        lastAlert = Date.now();
      }
    }

    refresh();
  </script>
</body>
</html>