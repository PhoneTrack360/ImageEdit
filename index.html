<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTC/USD Live Predictor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen p-4">
  <div class="max-w-4xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold text-center text-green-400">BTC/USD Live Predictor</h1>

    <div class="text-center mt-2">
      <span>Current Price: <span id="currentPrice" class="font-bold text-yellow-300">--</span></span>
    </div>
    <div class="text-center text-sm mt-1 text-gray-300">
      <span>Change 12h: <span id="change12h">--</span></span> |
      <span>Change 24h: <span id="change24h">--</span></span>
    </div>

    <div class="text-center mt-3">
      <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">
        Refresh Prediction
      </button>
      <select id="timeframe" class="ml-4 bg-gray-700 text-white py-1 px-2 rounded" onchange="fetchKlines()">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </div>

    <div class="text-center text-sm mt-2 text-gray-300">
      <div>Previous High: <span id="high">--</span> | Low: <span id="low">--</span></div>
      <div>Midday High: <span id="midhigh">--</span> | Low: <span id="midlow">--</span></div>
    </div>

    <div class="text-center text-lg mt-4">
      Prediction: <span id="prediction" class="font-bold text-yellow-400">Waiting...</span>
      <i id="pred-icon" class="fas fa-minus text-yellow-400 ml-2"></i>
    </div>

    <div class="grid grid-cols-2 gap-4 text-sm mt-4">
      <div>RSI (14): <span id="rsi">--</span></div>
      <div>MACD Hist: <span id="macd">--</span></div>
      <div>Parabolic SAR: <span id="psar">--</span></div>
      <div>Delta Volume: <span id="cdv">--</span></div>
    </div>
  </div>

  <!-- Alert sounds -->
  <audio id="bullishSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="bearishSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
  let candles = [], currentPrice = 0, lastAlert = 0, price12h = null, price24h = null;

  function speak(text) {
    if (!window.speechSynthesis) return;
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'en-US';
    speechSynthesis.speak(msg);
  }

  function computeRSI(closes, period=14) {
    if (closes.length < period+1) return null;
    let gains=0, losses=0;
    for (let i=1; i<=period; i++){
      const d = closes[i]-closes[i-1];
      if (d>0) gains+=d; else losses-=d;
    }
    let avgG=gains/period, avgL=losses/period;
    for (let i=period+1; i<closes.length; i++){
      const d = closes[i]-closes[i-1];
      avgG = (avgG*(period-1)+Math.max(d,0))/period;
      avgL = (avgL*(period-1)+Math.max(-d,0))/period;
    }
    if (avgL===0) return 100;
    const rs = avgG/avgL;
    return 100 - (100 / (1+rs));
  }

  function emaArray(vals, per) {
    const k = 2/(per+1), out=[vals[0]];
    for (let i=1;i<vals.length;i++){
      out.push(vals[i]*k + out[i-1]*(1-k));
    }
    return out;
  }

  function computeMACD(closes) {
    if (closes.length < 35) return null;
    const e12 = emaArray(closes, 12);
    const e26 = emaArray(closes, 26);
    const macdLine = e12.slice(26-1).map((v,i)=>v - e26[i+26-1]);
    const signal = emaArray(macdLine, 9);
    const hist = macdLine.slice(9-1).map((v,i)=>v - signal[i]);
    return { hist: hist.at(-1) };
  }

  function computePSAR(highs, lows, step=0.02, max=0.2) {
    if (highs.length<2) return null;
    let psar=lows[0], ep=highs[0], af=step, bull=true;
    for (let i=1;i<highs.length;i++){
      const prior=psar;
      psar = bull ?
        psar + af*(ep-psar) :
        psar - af*(psar-ep);
      if (bull && lows[i]<psar){
        bull=false; psar=ep; ep=lows[i]; af=step;
      } else if (!bull && highs[i]>psar){
        bull=true; psar=ep; ep=highs[i]; af=step;
      }
      if (bull){
        if (highs[i]>ep) ep=highs[i], af=Math.min(max, af+step);
      } else {
        if (lows[i]<ep) ep=lows[i], af=Math.min(max, af+step);
      }
    }
    return psar;
  }

  function setPrediction(txt, icon, col){
    document.getElementById('prediction').textContent=txt;
    document.getElementById('prediction').className=`font-bold ${col}`;
    document.getElementById('pred-icon').className=`fas ${icon} ml-2 ${col}`;
  }

  function alertOnTouch(price, levels){
    if (Date.now() - lastAlert < 10000) return;
    for (const lvl of levels){
      if (Math.abs(price - lvl.value)/lvl.value < 0.0005){
        document.getElementById(lvl.type==='bull'?'bullishSound':'bearishSound').play();
        speak(`${lvl.type==='bull'?'Bullish':'Bearish'} breakout at ${lvl.name}`);
        lastAlert=Date.now();
        break;
      }
    }
  }

  function updatePercentChanges(){
    const fmt=(old)=>old ? ((currentPrice-old)/old*100).toFixed(2) : '--';
    const c12=fmt(price12h), c24=fmt(price24h);
    const e12=document.getElementById('change12h'),
          e24=document.getElementById('change24h');
    e12.textContent=c12+'%'; e24.textContent=c24+'%';
    e12.className=c12>=0?'text-green-400':'text-red-400';
    e24.className=c24>=0?'text-green-400':'text-red-400';
  }

  function compute(){
    const cls=candles.map(c=>c.c), hs=candles.map(c=>c.h), ls=candles.map(c=>c.l);
    const rsi=computeRSI(cls), macdO=computeMACD(cls), psar=computePSAR(hs,ls);
    const cdv=candles.at(-1).cdv||0;

    document.getElementById('rsi').textContent=rsi?.toFixed(2)||'--';
    document.getElementById('macd').textContent=macdO?.hist.toFixed(3)||'--';
    document.getElementById('psar').textContent=psar?.toFixed(2)||'--';
    document.getElementById('cdv').textContent=cdv.toFixed(2);
    document.getElementById('currentPrice').textContent=currentPrice.toFixed(2);
    updatePercentChanges();

    const prevH=parseFloat(document.getElementById('high').textContent),
          prevL=parseFloat(document.getElementById('low').textContent);
    const now=new Date(), hr=now.getUTCHours(), evening=hr>=18;
    const morning=candles.filter(c=>new Date(c.t).getUTCHours()<12);
    const midH=Math.max(...morning.map(c=>c.h)), midL=Math.min(...morning.map(c=>c.l));
    document.getElementById('midhigh').textContent=midH.toFixed(2);
    document.getElementById('midlow').textContent=midL.toFixed(2);

    let bull=0, bear=0;
    if (currentPrice>prevH*0.985) bull+=40;
    if (currentPrice<prevL*1.015) bear+=40;
    if (evening){
      if (currentPrice>midH) bull+=15;
      if (currentPrice<midL) bear+=15;
    }
    if (macdO?.hist>0) bull+=10; else bear+=10;
    if (rsi>55) bull+=10; else if (rsi<45) bear+=10;
    if (cdv>0) bull+=15; else bear+=15;

    alertOnTouch(currentPrice, [
      {value:prevH,name:'Previous High',type:'bull'},
      {value:prevL,name:'Previous Low',type:'bear'},
      {value:midH,name:'Midday High',type:'bull'},
      {value:midL,name:'Midday Low',type:'bear'}
    ]);

    if (bull>bear && bull>=55) setPrediction(`Bullish (${bull}%)`,`fa-arrow-up`,'text-green-400');
    else if (bear>bull && bear>=55) setPrediction(`Bearish (${bear}%)`,`fa-arrow-down`,'text-red-400');
    else setPrediction('Neutral','fa-minus','text-yellow-400');
  }

  function fetchKlines(){
    const tf=document.getElementById('timeframe').value;
    fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${tf}&limit=500`)
      .then(r=>r.json()).then(d=>{
        candles=d.map(k=>({t:k[0],o:+k[1],h:+k[2],l:+k[3],c:+k[4],v:+k[5],cdv:0}));
        const y=new Date(); y.setUTCDate(y.getUTCDate()-1);
        const pd=candles.filter(c=>new Date(c.t).getUTCDate()===y.getUTCDate());
        if (pd.length){
          document.getElementById('high').textContent=Math.max(...pd.map(c=>c.h)).toFixed(2);
          document.getElementById('low').textContent=Math.min(...pd.map(c=>c.l)).toFixed(2);
        }
        const now=Date.now();
        const p12=candles.find(c=> now-c.t>=12*3600e3);
        const p24=candles.find(c=> now-c.t>=24*3600e3);
        price12h=p12?.c; price24h=p24?.c;
      });
  }

  function refreshData(){fetchKlines()}

  fetchKlines();
  const ws=new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_1m");
  ws.onmessage=e=>{
    const m=JSON.parse(e.data).k;
    currentPrice=+m.c;
    const cdv=+m.v*(+m.c-+m.o);
    candles.push({t:+m.t,o:+m.o,h:+m.h,l:+m.l,c:+m.c,v:+m.v,cdv});
    if(candles.length>500) candles.shift();
    compute();
  };
  </script>
</body>
</html>