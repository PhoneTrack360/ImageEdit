<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BTC/USD Predictor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen p-4">
  <div class="max-w-4xl mx-auto space-y-4">
    <h1 class="text-2xl font-bold text-center text-green-400">BTC/USD Live Predictor</h1>

    <div class="text-center mt-2">
      Current Price: <span id="currentPrice" class="font-bold text-yellow-300">--</span>
    </div>

    <div class="text-center text-sm mt-1 text-gray-300">
      Change 12h: <span id="change12h">--</span> | Change 24h: <span id="change24h">--</span>
    </div>

    <div class="text-center mt-3">
      <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded">
        Refresh Prediction
      </button>
      <select id="timeframe" class="ml-4 bg-gray-700 text-white p-1 rounded" onchange="fetchKlines()">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
        <option value="1d">1d</option>
      </select>
    </div>

    <div class="text-center text-sm text-gray-300 mt-2">
      Previous High: <span id="high">--</span> | Low: <span id="low">--</span><br>
      Midday High: <span id="midhigh">--</span> | Low: <span id="midlow">--</span>
    </div>

    <div class="text-center text-lg mt-4">
      Prediction: <span id="prediction" class="font-bold text-yellow-400">Waiting...</span>
      <i id="pred-icon" class="fas fa-minus text-yellow-400 ml-2"></i>
    </div>

    <div class="grid grid-cols-2 gap-4 text-sm mt-4">
      <div>RSI: <span id="rsi">--</span></div>
      <div>MACD Hist: <span id="macd">--</span></div>
      <div>Parabolic SAR: <span id="psar">--</span></div>
      <div>Delta Volume: <span id="cdv">--</span></div>
    </div>
  </div>

  <!-- Audio alerts -->
  <audio id="bullishSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="bearishSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    let candles = [], currentPrice = 0, lastAlert = 0, price12h = null, price24h = null;

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      speechSynthesis.speak(msg);
    }

    function rsiCalc(closes) {
      let gain=0, loss=0;
      for (let i=1; i<=14; i++) {
        const d=closes[i]-closes[i-1];
        if (d>0) gain+=d; else loss-=d;
      }
      const rs = gain/(loss||1);
      return 100 - 100/(1+rs);
    }

    function macdCalc(closes) {
      const ema = (arr, len) => {
        let k=2/(len+1), e=arr[0];
        for (let i=1;i<arr.length;i++) e=arr[i]*k + e*(1-k);
        return e;
      };
      const fast = ema(closes.slice(-12),12), slow=ema(closes.slice(-26),26);
      return fast - slow;
    }

    function psarCalc(highs, lows) {
      return highs.at(-2) > highs.at(-3) ? lows.at(-2): highs.at(-2);
    }

    function setPrediction(text, icon, color) {
      const pEl = document.getElementById('prediction');
      pEl.textContent = text;
      pEl.className = `font-bold ${color}`;
      const iEl = document.getElementById('pred-icon');
      iEl.className = `fas ${icon} ml-2 ${color}`;
    }

    function alertOnTouch(price, levels) {
      if (Date.now() - lastAlert < 10000) return;
      for (const lvl of levels) {
        if (Math.abs(price - lvl.value)/lvl.value < 0.0005) {
          const sound = lvl.type==='bull'?'bullishSound':'bearishSound';
          document.getElementById(sound).play();
          speak(`${lvl.type==='bull'?'Bullish':'Bearish'} breakout detected at ${lvl.name}`);
          lastAlert = Date.now();
          break;
        }
      }
    }

    function updateChangeDisplays() {
      const fmt = (old) => old!=null ? ((currentPrice-old)/old*100).toFixed(2) : "--";
      const c12 = fmt(price12h), c24 = fmt(price24h);
      const e12 = document.getElementById('change12h'), e24 = document.getElementById('change24h');
      e12.textContent = `${c12}%`; e24.textContent=`${c24}%`;
      e12.className = c12>=0?'text-green-400':'text-red-400';
      e24.className = c24>=0?'text-green-400':'text-red-400';
    }

    function compute() {
      const cls=candles.map(x=>x.c), hs=candles.map(x=>x.h), ls=candles.map(x=>x.l);
      const rsi=rsiCalc(cls), macd=macdCalc(cls), psar=psarCalc(hs,ls);
      const cdv = candles.at(-1).cdv||0;

      ['rsi','macd','psar','cdv','currentPrice'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.textContent = id==='currentPrice' ? currentPrice.toFixed(2) : (id==='macd'? macd.toFixed(3): id==='cdv' ? cdv.toFixed(2) : rsi.toFixed(2));
      });

      updateChangeDisplays();

      const prevH=parseFloat(document.getElementById('high').textContent),
            prevL=parseFloat(document.getElementById('low').textContent);
      const now=new Date(), hr=now.getUTCHours(), afternoon=hr>=18;
      const morning = candles.filter(k => new Date(k.t).getUTCHours()<12);
      const midH=Math.max(...morning.map(k=>k.h)), midL=Math.min(...morning.map(k=>k.l));
      document.getElementById('midhigh').textContent = midH.toFixed(2);
      document.getElementById('midlow').textContent = midL.toFixed(2);

      let bull=0, bear=0;
      if (currentPrice>prevH*0.985) bull+=40;
      if (currentPrice<prevL*1.015) bear+=40;
      if (afternoon) {
        if (currentPrice>midH) bull+=15;
        if (currentPrice<midL) bear+=15;
      }
      if (macd>0) bull+=10; else bear+=10;
      if (rsi>55) bull+=10; else if (rsi<45) bear+=10;
      if (cdv>0) bull+=15; else bear+=15;

      alertOnTouch(currentPrice, [
        {value:prevH,name:'Previous High',type:'bull'},
        {value:prevL,name:'Previous Low',type:'bear'},
        {value:midH,name:'Midday High',type:'bull'},
        {value:midL,name:'Midday Low',type:'bear'}
      ]);

      if (bull>bear && bull>=55) setPrediction(`Bullish (${bull}%)`,`fa-arrow-up`,'text-green-400');
      else if (bear>bull && bear>=55) setPrediction(`Bearish (${bear}%)`,`fa-arrow-down`,'text-red-400');
      else setPrediction('Neutral','fa-minus','text-yellow-400');
    }

    function fetchKlines() {
      const tf=document.getElementById('timeframe').value;
      fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${tf}&limit=500`)
        .then(r=>r.json())
        .then(d=>{
          candles = d.map(k => ({t:k[0],o:+k[1],h:+k[2],l:+k[3],c:+k[4],v:+k[5],cdv:0}));
          const y=new Date(); y.setUTCDate(y.getUTCDate()-1);
          const prevDay=candles.filter(k=>new Date(k.t).getUTCDate()===y.getUTCDate());
          if (prevDay.length){
            const prevH=Math.max(...prevDay.map(x=>x.h)),
                  prevL=Math.min(...prevDay.map(x=>x.l));
            document.getElementById('high').textContent=prevH.toFixed(2);
            document.getElementById('low').textContent=prevL.toFixed(2);
          }

          const now=Date.now();
          const p12=candles.find(k=> now-k.t >=12*3600e3);
          const p24=candles.find(k=> now-k.t >=24*3600e3);
          price12h = p12 ? p12.c : null;
          price24h = p24 ? p24.c : null;
        });
    }

    function refreshData(){ fetchKlines(); }

    fetchKlines();
    const ws=new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_1m");
    ws.onmessage=e=>{
      const m=JSON.parse(e.data).k;
      currentPrice = +m.c;
      const cdv = +m.v*(+m.c - +m.o);
      candles.push({t:+m.t,o:+m.o,h:+m.h,l:+m.l,c:+m.c,v:+m.v,cdv});
      if (candles.length>500) candles.shift();
      compute();
    };
  </script>
</body>
</html>